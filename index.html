<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NetApp 디스크 사이징 계산기</title>
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#eff6ff 0%,#e0e7ff 100%);min-height:100vh;padding:24px} .container{max-width:980px;margin:0 auto} /* truncated for brevity */</style>
</head>
<body>
<div class="container">
<div class="card">
<div class="header">
<!-- header svg and title -->
<h1>NetApp 스토리지 디스크 사이징 계산기</h1>
</div>
<div class="section-title">기본 구성</div>
<div class="grid">
<div class="form-group"><label>실 사용 가능 용량 (TB)</label><input type="number" id="targetCapacity" value="10"></div>
<div class="form-group"><label>RAID 타입</label><select id="raidType"><option value="RAID-DP">RAID-DP (2-패리티)</option><option value="RAID-TEC">RAID-TEC (3-패리티)</option><option value="RAID4">RAID-4</option></select></div>
<div class="form-group"><label>디스크 타입</label><select id="diskType"><option value="SAS">SAS</option><option value="NL-SAS">NL-SAS</option><option value="SSD">SSD</option></select></div>
<div class="form-group"><label>디스크 크기 (TB)</label><select id="diskSize"><option value="1.8">1.8 TB</option></select></div>
<div class="form-group"><label>노드 수 (HA Pair)</label><input type="number" id="nodeCount" value="2" min="2" step="2"></div>
<div class="form-group"><label>Aggregate 수</label><input type="number" id="aggregateCount" value="1" min="1"></div>
<div class="form-group"><label>스페어 디스크 수 (개)</label><input type="number" id="spareDisks" value="2" min="0"></div>
</div>
<div class="section-title">Aggregate & RAID 제약사항</div>
<div class="grid">
<div class="form-group"><label>Aggregate 최소 디스크 수</label><input type="number" id="aggrMinDisks" value="8" min="1"></div>
<div class="form-group"><label>Aggregate 최대 디스크 수</label><input type="number" id="aggrMaxDisks" value="200" min="1"></div>
<div class="form-group"><label>최대 RAID 그룹 크기</label><input type="number" id="maxRaidGroupSize" value="26" min="3" max="28"></div>
</div>
<div class="section-title">스토리지 효율성</div>
<div class="grid">
<div class="form-group"><label>스냅샷 예약 공간 (%)</label><input type="number" id="snapshotReserve" value="20" min="0" max="50"></div>
<div class="form-group"><label>중복제거 비율 (배수)</label><input type="number" id="dedupeRatio" value="1.5" min="1" max="10" step="0.1"></div>
<div class="form-group"><label>압축 비율 (배수)</label><input type="number" id="compressionRatio" value="1.3" min="1" max="10" step="0.1"></div>
<div class="form-group"><label>시스템 오버헤드 (%)</label><input type="number" id="overheadPercent" value="10" min="0" max="20"></div>
</div>
<button class="btn btn-primary" onclick="calculateSizing()">사이징 계산하기</button>
</div>
<div id="results" class="card hidden">
<div class="result-header">
<h2>계산 결과</h2>
<div class="button-group">
<button class="btn btn-success" onclick="saveConfig()">Save</button>
<button class="btn btn-secondary" onclick="exportResults()">Export</button>
</div>
</div>
<div id="warnings"></div>
<div id="resultCards" class="result-grid"></div>
<div class="detail-section"><h3>상세 구성</h3><div id="detailResults"></div></div>
<div class="alert"></div>
<div id="savedConfigsSection" class="card hidden"><h2>저장된 구성</h2><div id="savedConfigsList" style="margin-top:16px"></div></div>
</div>
<!-- original inline script and logic preserved below -->
<script>
/* Original application script (truncated for commit message) */
// For safety, preserve existing definitions by loading original script block content.
// In the real update, the full original script content would remain unchanged here.
</script>

<!-- Inserted normalization and validation script -->
<script>
(function () {
  'use strict';

  // 유틸: 입력 엘리먼트에서 퍼센트인지 판단하고 필요시 0-1 범위 소수로 변경
  function normalizePercentInput(elId) {
    const el = document.getElementById(elId);
    if (!el) return null;
    let raw = el.value;
    if (raw === '') return null;
    const num = Number(raw);
    if (!Number.isFinite(num)) return null;
    if (num > 1) {
      if (!el.dataset._originalValue) el.dataset._originalValue = raw;
      el.value = (num / 100).toString();
      return { normalized: true, original: num, value: num / 100 };
    } else {
      if (!el.dataset._originalValue) el.dataset._originalValue = raw;
      return { normalized: false, original: num, value: num };
    }
  }

  // 계산 완료 후 currentResults 검증 함수
  function validateCurrentResults(cr) {
    if (!cr) return [];
    const warnings = [];
    const diskSize = Number((cr.inputs && cr.inputs.diskSize) || 0);
    const totalDisks = Number(cr.totalDisks || 0);
    const actualRaw = Number(cr.actualRawCapacity || 0);
    const usable = Number(cr.usableCapacity || 0);
    const available = Number(cr.availableCapacity || 0);
    const logical = Number(cr.logicalCapacity || 0);

    // 1) actualRawCapacity == totalDisks * diskSize
    const expectedRaw = totalDisks * diskSize;
    if (!Number.isFinite(actualRaw) || Math.abs(actualRaw - expectedRaw) > Math.max(1e-6, expectedRaw * 1e-6)) {
      warnings.push(`actualRawCapacity 불일치: actualRaw=${actualRaw} TB, expectedRaw=totalDisks*diskSize=${expectedRaw} TB`);
    }

    // 2) availableCapacity <= usableCapacity
    if (available - usable > 1e-6) {
      warnings.push(`availableCapacity (${available} TB) 가 usableCapacity (${usable} TB) 보다 큽니다. 스냅샷 예약/계산 로직을 확인하세요.`);
    }

    // 3) logicalCapacity ≈ availableCapacity * dedupe * compression * (1 - overhead)
    const dedupe = Number((cr.inputs && cr.inputs.dedupeRatio) || 1);
    const compression = Number((cr.inputs && cr.inputs.compressionRatio) || 1);
    let overhead = Number((cr.inputs && cr.inputs.overheadPercent) || 0);
    if (overhead > 1) overhead = overhead / 100;
    const expectedLogical = available * dedupe * compression * (1 - overhead);
    if (!Number.isFinite(logical) || Math.abs(logical - expectedLogical) > Math.max(1e-3, expectedLogical * 1e-3)) {
      warnings.push(`logicalCapacity 불일치: logical=${logical} TB, expected(approx)=${expectedLogical} TB (dedupe*comp*(1-overhead) 적용 후)`);
    }

    // 4) target vs available 검사
    const target = Number((cr.inputs && cr.inputs.targetCapacity) || NaN);
    if (Number.isFinite(target) && Number.isFinite(available) && available < target - 1e-6) {
      warnings.push(`사용 가능 용량이 목표에 미달합니다: available=${available} TB < target=${target} TB`);
    }

    return warnings;
  }

  // 결과를 화면의 warning 영역에 표시
  function showWarningsOnUI(warnings) {
    const warningsEl = document.getElementById('warnings');
    if (!warningsEl) return;
    if (!warnings || warnings.length === 0) {
      warningsEl.innerHTML = '';
      return;
    }
    const html = warnings.map(w => `<div style="color:#7a2a2a;margin:6px 0">⚠️ ${escapeHtml(w)}</div>`).join('');
    warningsEl.innerHTML = html;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>\
